<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Checkout ¬∑ Montji</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">üçΩÔ∏è Montji</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a href="shop.html" class="nav-link">Shop</a></li>
        <li class="nav-item"><a href="cart.html" class="nav-link">Cart</a></li>
      </ul>
      <span id="navRole" class="badge bg-secondary me-2 badge-role"></span>
      <a id="navDashboard" href="dashboard.html" class="btn btn-sm btn-outline-secondary me-2" style="display:none;">Dashboard</a>
      <a id="navLogin" href="login.html" class="btn btn-sm btn-outline-primary me-2">Login</a>
      <button id="navLogout" class="btn btn-sm btn-outline-danger" style="display:none;">Logout</button>
    </div>
  </div>
</nav>

<section class="container py-4">
  <h1 class="h3 mb-3">Checkout</h1>
  <div id="checkout"></div>
</section>
<script>
const state = loadState();
const user = currentUser(state);
if (!user) {
  notify("Please register or login first.");
  location.href = "register.html?next=checkout.html";
}

const cart = getCart(state, user);
const items = (cart.items || []).map(it => ({...it, dish: state.dishes.find(d=>d.id===it.dishId)}));
let deliveryType = "pickup_family";
let deliveryCompanyId = state.deliveryCompanies[0]?.id || null;
let distanceKm = 10;

function summary() {
  let subtotal = 0;
  items.forEach(it => subtotal += applyDiscounts(it.dish, it.qty, it.size) * it.qty);
  const delco = state.deliveryCompanies.find(d=>d.id===deliveryCompanyId) || null;
  const dCost = deliveryType === "delivery_to_home" ? deliveryCost(delco, Number(distanceKm)) : 0;
  const total = (subtotal + dCost).toFixed(3);
  return { subtotal, dCost, total, delco };
}

function placeOrder() {
  const { subtotal, dCost, total } = summary();
  const order = {
    id: uid(),
    customerId: user.id,
    items: cart.items,
    status: "pending",
    deliveryType,
    deliveryCompanyId,
    distanceKm: Number(distanceKm),
    scheduledAt: new Date().toISOString(),
    payment: { method: null, approvedLink: null, paid: false }
  };
  state.orders.unshift(order);
  cart.items = [];
  setCart(state, user, cart);
  saveState(state);
  notify("Order placed. Await approval.");
  location.href = "orders.html";
}

function render() {
  const { subtotal, dCost, total, delco } = summary();
  document.getElementById('checkout').innerHTML = `
    <div class="row g-3">
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <h5>Delivery Options</h5>
            <select class="form-select my-2" id="dtype">
              <option value="pickup_family">Pick up from family home</option>
              <option value="pickup_shop">Pick up from businessman shop</option>
              <option value="delivery_to_home">Delivery to my home</option>
            </select>
            <div id="deliveryExtra" style="display:${deliveryType==='delivery_to_home'?'block':'none'}">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label small">Delivery Company</label>
                  <select id="delco" class="form-select">
                    ${state.deliveryCompanies.map(d=>`<option value="${d.id}" ${d.id===deliveryCompanyId?'selected':''}>${d.name}</option>`).join("")}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label small">Distance (km)</label>
                  <input id="km" type="number" class="form-control" value="${distanceKm}" min="1">
                </div>
                <div class="col-12 small text-muted">Cost: base up to ${delco?.baseKm} km, then + per ${delco?.stepKm} km.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5>Order Summary</h5>
            ${(items||[]).map(it=>`
              <div class="d-flex justify-content-between small">
                <div>${it.qty}√ó ${it.dish.title} (${it.size})</div>
                <div>${(applyDiscounts(it.dish, it.qty, it.size)*it.qty).toFixed(3)} ${state.settings.currency}</div>
              </div>`).join("")}
            <div class="d-flex justify-content-between mt-2">
              <div>Subtotal</div><div class="fw-semibold">${subtotal.toFixed(3)} ${state.settings.currency}</div>
            </div>
            ${deliveryType==='delivery_to_home'?`<div class="d-flex justify-content-between"><div>Delivery</div><div class="fw-semibold">${dCost.toFixed(3)} ${state.settings.currency}</div></div>`:""}
            <div class="d-flex justify-content-between mt-2">
              <div class="fw-bold">Total</div><div class="fw-bold">${total} ${state.settings.currency}</div>
            </div>
            <button class="btn btn-primary w-100 mt-3" onclick="placeOrder()">Place Order (approval needed)</button>
          </div>
        </div>
      </div>
    </div>`;
  const dtype = document.getElementById('dtype');
  dtype.value = deliveryType;
  dtype.addEventListener('change', (e)=>{ deliveryType = e.target.value; render(); });
  const km = document.getElementById('km');
  if (km) km.addEventListener('input', e=>{ distanceKm = e.target.value; render(); });
  const delcoSel = document.getElementById('delco');
  if (delcoSel) delcoSel.addEventListener('change', e=>{ deliveryCompanyId = e.target.value; render(); });
}
render();
</script>

<footer class="footer py-4 mt-5">
  <div class="container d-flex justify-content-between small">
    <div>¬© 2025 Montji Demo</div>
    <div>
      <a href="dashboard.html" class="text-decoration-none me-3">Dashboards</a>
      <a href="https://github.com/" target="_blank" class="text-decoration-none">GitHub</a>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="assets/js/data.js"></script>
<script src="assets/js/utils.js"></script>
<script src="assets/js/app.js"></script>
<script>AOS.init();</script>
</body>
</html>
