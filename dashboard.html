<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboards ¬∑ Montji</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">üçΩÔ∏è Montji</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a href="shop.html" class="nav-link">Shop</a></li>
        <li class="nav-item"><a href="cart.html" class="nav-link">Cart</a></li>
      </ul>
      <span id="navRole" class="badge bg-secondary me-2 badge-role"></span>
      <a id="navDashboard" href="dashboard.html" class="btn btn-sm btn-outline-secondary me-2" style="display:none;">Dashboard</a>
      <a id="navLogin" href="login.html" class="btn btn-sm btn-outline-primary me-2">Login</a>
      <button id="navLogout" class="btn btn-sm btn-outline-danger" style="display:none;">Logout</button>
    </div>
  </div>
</nav>

<section class="container py-4">
  <h1 class="h3 mb-3">Dashboards</h1>
  <div id="guard" class="alert alert-warning d-none">Please login to view dashboards.</div>
  <ul class="nav nav-tabs" id="roleTabs"></ul>
  <div class="tab-content border border-top-0 p-3 rounded-bottom" id="rolePanels"></div>
</section>
<script>
const state = loadState();
const user = currentUser(state);
const guard = document.getElementById('guard');
if (!user) { guard.classList.remove('d-none'); }

const tabs = [
  { id:"admin", label:"Admin" },
  { id:"employee", label:"Employee" },
  { id:"deliverycompany", label:"Delivery Company" },
  { id:"businessman", label:"Businessman" },
  { id:"familybusiness", label:"Family Business" },
  { id:"customer", label:"Customer" }
];

const roleTabs = document.getElementById('roleTabs');
const rolePanels = document.getElementById('rolePanels');
tabs.forEach(t=>{
  const li = document.createElement('li'); li.className="nav-item";
  li.innerHTML = `<button class="nav-link ${user && user.role===t.id ? 'active':''}" data-bs-toggle="tab" data-bs-target="#panel-${t.id}">${t.label}</button>`;
  roleTabs.appendChild(li);

  const pane = document.createElement('div'); pane.className = `tab-pane fade ${user && user.role===t.id ? 'show active':''}`; pane.id = `panel-${t.id}`;
  pane.innerHTML = `<div id="content-${t.id}"></div>`;
  rolePanels.appendChild(pane);
});

// ---- Helpers ----
function kpi(label, value){ return `<div class="col"><div class="card"><div class="card-body"><div class="text-muted small">${label}</div><div class="fw-bold fs-5">${value}</div></div></div></div>`; }

// ADMIN
(function(){
  const el = document.getElementById('content-admin');
  if (!el) return;
  const delivered = state.orders.filter(o=>o.status==='delivered').length;
  const partners = state.users.filter(u=>['businessman','familybusiness'].includes(u.role)).length;
  el.innerHTML = `
    <div class="row row-cols-2 row-cols-md-4 g-3 mb-3">
      ${kpi('Delivered orders', delivered)}
      ${kpi('Partners', partners)}
      ${kpi('Shelves', state.shelves.length)}
      ${kpi('Ads', state.ads.length)}
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100"><div class="card-body">
          <h5>Approve Partners</h5>
          <div class="input-group">
            <input id="approveEmail" class="form-control" placeholder="email@domain">
            <button class="btn btn-primary" onclick="notify('Approved '+document.getElementById('approveEmail').value)">Approve</button>
          </div>
        </div></div>
      </div>
      <div class="col-md-6">
        <div class="card h-100"><div class="card-body">
          <h5>Register Employee</h5>
          <div class="row g-2">
            <div class="col"><input id="empName" class="form-control" placeholder="Name"></div>
            <div class="col"><input id="empEmail" class="form-control" placeholder="email@domain"></div>
            <div class="col-12 d-grid"><button class="btn btn-outline-primary" onclick="
              (function(){
                const s = loadState();
                s.users.push({ id: uid(), role:'employee', name: document.getElementById('empName').value, email: document.getElementById('empEmail').value, password: 'demo' });
                saveState(s); notify('Employee added');
              })()">Add</button></div>
          </div>
        </div></div>
      </div>
      <div class="col-12">
        <div class="card"><div class="card-body">
          <h5>Montji Fees</h5>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Sales</th><th>Businessman</th><th>Family Business</th></tr></thead>
              <tbody>
                <tr><td>Less than 500 OMR</td><td>10 OMR / month</td><td>5 OMR / month</td></tr>
                <tr><td>Each +500 OMR</td><td>+5 OMR / month</td><td>+5 OMR / month</td></tr>
              </tbody>
            </table>
          </div>
        </div></div>
      </div>
    </div>`;
})();

// BUSINESSMAN
(function(){
  const el = document.getElementById('content-businessman');
  if (!el) return;
  const me = state.users.find(u=>u.role==='businessman');
  const myOrders = state.orders.filter(o => o.items.some(it => {
    const d = state.dishes.find(x=>x.id===it.dishId);
    return d && ((d.ownerType==='businessman' && d.ownerId===me.id) || (d.availableAtShopOwnerId===me.id));
  }));
  const delivered = myOrders.filter(o=>o.status==='delivered').length;
  const revenue = myOrders.reduce((sum, o)=> sum + o.items.reduce((s, it)=>{
    const d = state.dishes.find(x=>x.id===it.dishId); return s + (applyDiscounts(d, it.qty, it.size) * it.qty);
  },0), 0);
  el.innerHTML = `
    <div class="row row-cols-2 row-cols-md-4 g-3 mb-3">
      ${kpi('Orders', myOrders.length)}
      ${kpi('Delivered', delivered)}
      ${kpi('Revenue (demo)', revenue.toFixed(2)+' OMR')}
      ${kpi('Shelves', state.shelves.filter(s=>s.shopOwnerId===me.id).length)}
    </div>
    <div class="card mb-3"><div class="card-body">
      <h5>Orders</h5>
      <div class="table-responsive"><table class="table table-sm align-middle">
        <thead><tr><th>ID</th><th>Status</th><th>Payment</th><th>Actions</th></tr></thead>
        <tbody>
          ${myOrders.map(o=>`
          <tr><td class="small text-monospace">${o.id}</td><td>${o.status}</td><td>${o.payment.paid?'Paid':'Unpaid'}</td>
          <td>
            ${o.status==='pending'?`<button class="btn btn-sm btn-primary" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:'approved',payment:{...x.payment,approvedLink:'https://pay.link/demo'}}:x); saveState(s); notify('Approved'); location.reload(); })()">Approve</button>`:''}
            ${['approved','out_for_delivery'].includes(o.status)?`<button class="btn btn-sm btn-outline-secondary" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:x.status==='approved'?'out_for_delivery':'delivered'}:x); saveState(s); notify('Advanced'); location.reload(); })()">Advance</button>`:''}
          </td></tr>`).join("")}
        </tbody></table></div>
    </div></div>
    <div class="card"><div class="card-body">
      <h5>Add Dish</h5>
      <div class="row g-2">
        <div class="col-md-6"><input id="bmDishTitle" class="form-control" placeholder="Dish title"></div>
        <div class="col-md-3"><input id="bmDishPrice" class="form-control" placeholder="Price (OMR)"></div>
        <div class="col-md-3 d-grid"><button class="btn btn-outline-primary" onclick="(function(){ const s=loadState(); s.dishes.unshift({ id: uid(), title: document.getElementById('bmDishTitle').value, price: Number(document.getElementById('bmDishPrice').value||0), foodType:'Omani', image:'https://picsum.photos/seed/food/800/500', ownerType:'businessman', ownerId:'${me.id}', city: (s.users.find(u=>u.id==='${me.id}').city||'Muscat'), sizeOptions:['Single','Family'], discounts:{generalPct:0,bySize:{},byQty:[]}, availableAtShopOwnerId:null }); saveState(s); notify('Dish added'); location.reload(); })()">Add</button></div>
      </div>
    </div></div>`;
})();

// FAMILY BUSINESS
(function(){
  const el = document.getElementById('content-familybusiness');
  if (!el) return;
  const me = state.users.find(u=>u.role==='familybusiness');
  const myOrders = state.orders.filter(o => o.items.some(it => {
    const d = state.dishes.find(x=>x.id===it.dishId);
    return d && d.ownerType==='familybusiness' && d.ownerId===me.id;
  }));
  const delivered = myOrders.filter(o=>o.status==='delivered').length;
  const revenue = myOrders.reduce((sum, o)=> sum + o.items.reduce((s, it)=>{
    const d = state.dishes.find(x=>x.id===it.dishId); return s + (applyDiscounts(d, it.qty, it.size) * it.qty);
  },0), 0);
  const shop = state.users.find(u=>u.role==='businessman');
  el.innerHTML = `
    <div class="row row-cols-2 row-cols-md-4 g-3 mb-3">
      ${kpi('Orders', myOrders.length)}
      ${kpi('Delivered', delivered)}
      ${kpi('Revenue (demo)', revenue.toFixed(2)+' OMR')}
      ${kpi('Dishes', state.dishes.filter(d=>d.ownerType==='familybusiness' && d.ownerId===me.id).length)}
    </div>
    <div class="card mb-3"><div class="card-body">
      <h5>Rent a Shelf</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <select id="reqShopId" class="form-select">
            ${state.users.filter(u=>u.role==='businessman').map(bm=>`<option value="${bm.id}">${bm.shopName || bm.name}</option>`).join("")}
          </select>
        </div>
        <div class="col-md-4"><input id="reqLen" class="form-control" placeholder="Length (cm)"></div>
        <div class="col-md-4"><input id="reqCost" class="form-control" placeholder="Monthly cost (OMR)"></div>
        <div class="col-12 d-grid mt-2"><button class="btn btn-outline-primary" onclick="(function(){ const s=loadState(); s.shelfRequests.unshift({ id: uid(), shelfId:null, shopOwnerId: document.getElementById('reqShopId').value, familyId: '${me.id}', requestedLengthCm: Number(document.getElementById('reqLen').value||0), requestedMonthlyCost: Number(document.getElementById('reqCost').value||0), status:'pending', createdAt:new Date().toISOString() }); saveState(s); notify('Shelf request sent'); })()">Request Shelf</button></div>
      </div>
    </div></div>
    <div class="card"><div class="card-body">
      <h5>Add Dish</h5>
      <div class="row g-2">
        <div class="col-md-6"><input id="famDishTitle" class="form-control" placeholder="Dish title"></div>
        <div class="col-md-3"><input id="famDishPrice" class="form-control" placeholder="Price (OMR)"></div>
        <div class="col-md-3 d-grid"><button class="btn btn-outline-primary" onclick="(function(){ const s=loadState(); s.dishes.unshift({ id: uid(), title: document.getElementById('famDishTitle').value, price: Number(document.getElementById('famDishPrice').value||0), foodType:'Omani', image:'https://picsum.photos/seed/family/800/500', ownerType:'familybusiness', ownerId:'${me.id}', city:(s.users.find(u=>u.id==='${me.id}').city||'Seeb'), sizeOptions:['Small','Medium','Large'], discounts:{generalPct:0,bySize:{},byQty:[]}, availableAtShopOwnerId:null }); saveState(s); notify('Dish added'); location.reload(); })()">Add</button></div>
      </div>
    </div></div>`;
})();

// EMPLOYEE
(function(){
  const el = document.getElementById('content-employee');
  if (!el) return;
  el.innerHTML = `
    <div class="card"><div class="card-body">
      <h5>Orders</h5>
      <div class="table-responsive"><table class="table table-sm align-middle">
        <thead><tr><th>ID</th><th>Status</th><th>Action</th></tr></thead>
        <tbody>
          ${state.orders.map(o=>`
            <tr>
              <td class="small text-monospace">${o.id}</td>
              <td>${o.status}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:'approved'}:x); saveState(s); notify('Approved'); location.reload(); })()">Approve</button>
                <button class="btn btn-sm btn-outline-danger" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:'cancelled'}:x); saveState(s); notify('Cancelled'); location.reload(); })()">Cancel</button>
              </td>
            </tr>`).join("")}
        </tbody>
      </table></div>
    </div></div>`;
})();

// DELIVERY COMPANY
(function(){
  const el = document.getElementById('content-deliverycompany');
  if (!el) return;
  const me = state.users.find(u=>u.role==='deliverycompany');
  const assigned = state.orders.filter(o=>o.deliveryCompanyId===me.id);
  el.innerHTML = `
    <div class="card"><div class="card-body">
      <h5>Assigned Orders</h5>
      <div class="table-responsive"><table class="table table-sm align-middle">
        <thead><tr><th>ID</th><th>Status</th><th>Action</th></tr></thead>
        <tbody>
          ${assigned.map(o=>`
            <tr>
              <td class="small text-monospace">${o.id}</td>
              <td>${o.status}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:'out_for_delivery'}:x); saveState(s); notify('Out for delivery'); location.reload(); })()">Out for delivery</button>
                <button class="btn btn-sm btn-outline-success" onclick="(function(){ const s=loadState(); s.orders=s.orders.map(x=>x.id==='${o.id}'?{...x,status:'delivered'}:x); saveState(s); notify('Delivered'); location.reload(); })()">Delivered</button>
              </td>
            </tr>`).join("")}
        </tbody>
      </table></div>
    </div></div>`;
})();

// CUSTOMER
(function(){
  const el = document.getElementById('content-customer');
  if (!el) return;
  const me = state.users.find(u=>u.role==='customer');
  const mine = state.orders.filter(o=>o.customerId===me?.id);
  el.innerHTML = `
    <div class="row row-cols-2 row-cols-md-4 g-3 mb-3">
      ${kpi('Pending', mine.filter(o=>o.status!=='delivered').length)}
      ${kpi('Delivered', mine.filter(o=>o.status==='delivered').length)}
      ${kpi('Reviews', '0')}
      ${kpi('Favorites', '0')}
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="orders.html">Open My Orders</a>`;
})();
</script>

<footer class="footer py-4 mt-5">
  <div class="container d-flex justify-content-between small">
    <div>¬© 2025 Montji Demo</div>
    <div>
      <a href="dashboard.html" class="text-decoration-none me-3">Dashboards</a>
      <a href="https://github.com/" target="_blank" class="text-decoration-none">GitHub</a>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="assets/js/data.js"></script>
<script src="assets/js/utils.js"></script>
<script src="assets/js/app.js"></script>
<script>AOS.init();</script>
</body>
</html>
